<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-client_id" content="1028455310019-lvgag11ncrp0enkf9ssr3eafohnkmrbt.apps.googleusercontent.com">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <title>FANCY TODO</title>
</head>
<body>
    <div id="navbar">
        <nav class="navbar navbar-expand-lg navbar-light" style="background-color: mediumturquoise;">
            <a class="navbar-brand">F Todo</a>
            <button onclick="loginPage()" class="btn" id="btn-login">login</button>
            <button onclick="registerPage()" class="btn" id="btn-register">register</button>
            <button class="btn" onclick="logout()" id="btn-logout">logout</button>
            <div class="g-signin2" data-onsuccess="onSignIn" id="btn-google"></div>
          </nav>
    </div>
    <div id="home-page" class="container">
    </div>
    <div id="login-page" class="container">
        <form action="" id="login-form">
            <label for="">email</label>
            <input type="email" id="login-email-input" placeholder="email"><br>
            <label for="">password</label>
            <input type="password" id="login-password-input" placeholder="password"><br>
            <input type="submit" >
        </form><br>
        <div class="g-signin2" data-onsuccess="onSignIn">
        </div>
    </div>
    <div id="register-page" class="container">
        <form action="" id="register-form" >
            <label for="">email</label>
            <input type="email" id="register-email-input" placeholder="email">
            <br>
            <label for="">password</label>
            <input type="password" id="register-password-input" placeholder="password"><br>
            <input type="submit" >
            <div class="g-signin2" data-onsuccess="onSignIn" id="btn-google"></div>
        </form>
    </div>
    <div id="todo-page" class="container">
        <h1>todo page</h1><br>
        <button onclick="showTodoForm()" class="btn btn-secondary">add todo</button>
        <form action="" id="todo-form" style="display: none;" class="row">
            <div class="form-group col-sm">
                <label for="" >title</label>
                <input type="text" placeholder="title" id="todo-form-title" class="form-control">
            </div>
            <div class="form-group col-sm">
                <label for="" >description</label>
                <input type="text" placeholder="description" id="todo-form-description" class="form-control">
            </div>
            <div class="form-group col-sm">
                <label for="" >due date</label>
                <input type="date" id="todo-form-due_date" class="form-control">
            </div>
            <input type="submit" class="btn" style="max-height: 30px;margin-top: 30px;">
        </form>
        <table id="table-todos" class="table">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">title</th>
                    <th scope="col">desc</th>
                    <th scope="col">status</th>
                    <th scope="col">due date</th>
                  </tr>
                  <tbody id="table-todos-body">
                    
                  </tbody>
            </thead>
        </table>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script>
        function loginPage(){
            $('#home-page').hide()
            $('#register-page').hide()
            $('#todo-page').hide()
            $('#login-form').trigger('reset')
            $('#login-page').show()
        }
        function registerPage(){
            $('#home-page').hide()
            $('#login-page').hide()
            $('#todo-page').hide()
            $('#register-form').trigger('reset')
            $('#register-page').show()
        }
        function todoPage(){
            $('#home-page').hide()
            $('#login-page').hide()
            $('#register-page').hide()
            $('#navbar').show()
            $('#btn-login').hide()
            $('#btn-google').hide()
            $('#btn-register').hide()
            $('#btn-logout').show()
            $('#todo-page').show()
            getTodo()
        }
        function getTodo(){
            $('#table-todos-body').empty()
            $.ajax({
                url: 'http://localhost:3000/todos',
                method: 'GET',
                headers:{
                    token: localStorage.getItem('token')
                }
            })
                .done(res =>{
                    res.forEach( (el,index )=> {
                        $('#table-todos-body').append(`
                        <tr>
                      <th scope="row">${index+1}</th>
                      <td>${el.title}</td>
                      <td>${el.description}</td>
                      <td>${el.status}</td>
                      <td>${el.due_date}</td>
                    </tr>`)
                    });
                })
                .fail(err =>{
                    console.log(err);
                })
        }
        function postLogin(email = $('#login-email-input').val(),password = $('#login-password-input').val()){
            $.ajax({
                url: 'http://localhost:3000/users/login',
                method: 'POST',
                data: {
                    email: email,
                    password: password
                }
            })
                .done(res =>{
                    localStorage.setItem('token',res.token)
                    isLoggedIn()
                })
                .fail(xhr =>{
                    alert(xhr.responseJSON.msg)
                    console.log(xhr);
                })
        }
        function postRegister(){
            $.ajax({
                url: 'http://localhost:3000/users/register',
                method: 'POST',
                data: {
                    email: $('#register-email-input').val(),
                    password: $('#register-password-input').val()
                }
            })
                .done(res =>{
                    postLogin($('#register-email-input').val(),$('#register-password-input').val())
                })
                .fail(xhr =>{
                    alert(xhr.responseJSON.msg)
                })
        }
        function logout(){
            localStorage.removeItem('token')
            var auth2 = gapi.auth2.getAuthInstance();
                auth2.signOut().then(function () {
                console.log('User signed out.');
            });
            isLoggedOut()
        }
        function isLoggedIn(){
            $('#home-page').hide()
            $('#login-page').hide()
            $('#register-page').hide()
            $('#home-page').hide()
            $('#navbar').show()
            $('#btn-login').hide()
            $('#btn-register').hide()
            $('#btn-google').hide()
            $('#btn-logout').show()
            $('#todo-page').show()
            todoPage()
        }
        function isLoggedOut(){
            $('#home-page').hide()
            $('#login-page').hide()
            $('#register-page').hide()
            $('#home-page').show()
            $('#navbar').show()
            $('#btn-login').show()
            $('#btn-register').show()
            $('#btn-google').show()
            $('#btn-logout').hide()
            $('#todo-page').hide()
        }
        function showTodoForm(){
            $('#todo-form').trigger('reset')
            $('#todo-form').show()
        }
        function postTodo(){
            $.ajax({
                url: 'http://localhost:3000/todos',
                method: 'POST',
                data: {
                    title: $('#todo-form-title').val(),
                    description: $('#todo-form-description').val(),
                    due_date: $('#todo-form-due_date').val()
                },
                headers:{
                    token: localStorage.getItem('token')
                }
            })
                .done(res =>{
                    $('#todo-form').trigger('reset')
                    $('#todo-form').hide()
                    getTodo()
                })
                .fail(xhr =>{
                    alert(xhr.responseJSON.msg)
                })
        }
        function onSignIn(googleUser) {
            console.log('masuk');
            var id_token = googleUser.getAuthResponse().id_token;
            $.ajax({
                url:'http://localhost:3000/users/googleLogin',
                method: 'POST',
                data:{
                    token: id_token
                }
            })
                .done(res=>{
                    console.log(res);
                    localStorage.setItem('token',res.token)
                    isLoggedIn()
                })
                .fail(err=>{
                    console.log(err);
                })
        }
        $(document).ready(()=>{
            // $('div').hide()
            if(!localStorage.getItem('token')){
                $('#home-page').hide()
                $('#login-page').hide()
                $('#register-page').hide()
                $('#todo-page').hide()
                $('#home-page').show()
                $('#btn-logout').hide()
            }else{
                $('#btn-logout').show()
                todoPage()
            }
            $('#login-form').on('submit', (e)=>{
                e.preventDefault()
                postLogin()
            })
            $('#register-form').on('submit', (e)=>{
                e.preventDefault()
                postRegister()
            })
            $('#todo-form').on('submit',(e)=>{
                e.preventDefault()
                postTodo()
            })
        })
    </script>
</body>
</html>